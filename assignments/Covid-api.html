<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Covid</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <style>
        body {
            padding-top: 200px;
        }

        select {
            height: 30px;
        }
    </style>
</head>
<center>
    <select name="countries" id="countries" class="countries">
        <option value="">Select Country</option>
    </select>

    <div class="card" style="width: 18rem; margin-top: 100px;">
        <div class="card-header">
            Data
        </div>
        <ul class="list-group list-group-flush">
            <li class="list-group-item">Active Cases: <span id="active-cases">--</span></li>
            <li class="list-group-item">Confirmed Cases: <span id="confirm-cases">--</span></li>
            <li class="list-group-item">Deaths: <span id="death-cases">--</span></li>
        </ul>
    </div>

    <div class="mt-5">
        <h1 id="country-name">--</h1>
    </div>

    <div class="mt-5">
        <input type="text" id="s-country" />
    </div>
    <ul class="list"></ul>


</center>

<body>
    <script>
        var gcountries = []
        var country_codes = {}
        var country_count = {}

        function ajaxGet(url) {
            var x = {}
            const xhttp = new XMLHttpRequest()
            xhttp.open("GET", url)
            xhttp.send()
            xhttp.onload = function () {
                x = JSON.parse(this.responseText)
                console.log(x)
            }
        }

        function onLoad() {

            var select = document.querySelector('.countries')
            select.addEventListener('change', function (event) {
                getCovidCounts(event.target.value)
            })

            const url = "https:api.covid19api.com/countries"
            const xhttp = new XMLHttpRequest()
            xhttp.open("GET", url)
            xhttp.send()
            xhttp.onload = function () {
                const countries = JSON.parse(this.responseText)
                countries.forEach((country, index) => {
                    gcountries[index] = country.Country
                    country_codes[country.Country] = country.ISO2
                    var option = document.createElement("option")
                    option.value = country.ISO2
                    option.id = country.ISO2
                    option.text = country.Country
                    select.appendChild(option)
                })
            }
            gcountries = gcountries.sort()

        }

        function getCovidCounts(id) {
            document.querySelector("#active-cases").innerText = "--"
            document.querySelector("#confirm-cases").innerText = "--"
            document.querySelector("#death-cases").innerText = "--"
            document.querySelector("#country-name").innerText = "Loading ..."
            if (id === "") {
                return
            }
            let count = [0, 0, 0]
            function setCount(count, name) {
                console.log(count)
                document.querySelector("#active-cases").innerText = count[0]
                document.querySelector("#confirm-cases").innerText = count[1]
                document.querySelector("#death-cases").innerText = count[2]
                document.querySelector("#country-name").innerText = name
            }
            const name = document.getElementById(id).innerText
            if (country_count.hasOwnProperty(id)) {
                setCount(country_count[id], name)
                return
            }
            const url = "https:api.covid19api.com/country/" + id
            const xhttp = new XMLHttpRequest()
            xhttp.open("GET", url)
            xhttp.send()
            xhttp.onload = function () {
                const data = JSON.parse(this.responseText)
                if (!data.hasOwnProperty('length')) {
                    document.querySelector("#country-name").innerText = "--"
                    window.alert("Api has huge traffic")
                }
                data.forEach(point => {
                    count[0] += point.Active
                    count[1] += point.Confirmed
                    count[2] += point.Deaths
                })
                country_count[id] = count
                setCount(count, name)
            }
        }

        function displayNames(value) {
            input_bar.value = value
            document.querySelector(`option[value="${country_codes[value]}"]`).selected = true
            getCovidCounts(country_codes[value])
            removeElements()
        }

        function removeElements() {
            let items = document.querySelectorAll(".list-items")
            items.forEach((item) => {
                item.remove()
            })
        }

        function getSuggestions(event) {
            removeElements()
            let cities = gcountries
            let val = event.target.value
            const list = document.querySelector(".list")
            let count = 0, id = null
            for (let city of cities) {
                if (city.toLowerCase().startsWith(val.toLowerCase()) && val != "") {
                    let listItem = document.createElement("li")
                    listItem.classList.add("list-items")
                    listItem.style.cursor = "pointer"
                    listItem.setAttribute("onclick", `displayNames('${city}')`)
                    let word = "<b>" + city.slice(0, val.length) + "</b>" + city.slice(val.length)
                    listItem.innerHTML = word
                    list.appendChild(listItem)
                    ++count
                    id = city
                }
            }
            // if (count == 1) {
            //     displayNames(id)
            // }
        }

        const input_bar = document.querySelector("#s-country")
        input_bar.addEventListener("keyup", getSuggestions)

        window.onload = onLoad
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"
        integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>
</body>

</html>
